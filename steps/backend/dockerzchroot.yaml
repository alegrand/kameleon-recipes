# Docker backend recipe
---
extend: chroot.yaml

checkpoint: dockerzchroot.yaml

global:

  ## ZFS options:
  zfs_cmd: sudo -k -n zfs
  zfs_kameleon_dataset: z/kameleon
  ## Docker options
  docker_image: $${kameleon_recipe_name}_$${kameleon_short_uuid}
  docker_hostname: kameleon-$${kameleon_short_uuid}

  # rootfs options
  rootfs_dataset: $${zfs_kameleon_dataset}/$${docker_image}
  rootfs_host_dir: /$${rootfs_dataset}/rootfs
  rootfs_container_dir: $${kameleon_cwd}/rootfs

  # Shell session from where we launch exec_out commands. There is often a
  # local bash session, but it can be a remote shell on other machines or on
  # any shell. (eg. bash, chroot, fakechroot, ssh, tmux, lxc...)
  out_context:
    cmd: test -s MAIN_CONTAINER_ID && LC_ALL=POSIX docker exec -i $(< MAIN_CONTAINER_ID) /bin/bash
    interactive_cmd: test -s MAIN_CONTAINER_ID && LC_ALL=POSIX docker exec -it $(< MAIN_CONTAINER_ID) /bin/bash
    workdir: $${kameleon_cwd}
    proxy_cache: localhost

  # Shell session that allows us to connect to the building machine in order to
  # configure it and setup additional programs
  in_context:
    cmd: test -s MAIN_CONTAINER_ID && LC_ALL=POSIX docker exec -i $(< MAIN_CONTAINER_ID) chroot $${rootfs_container_dir} /bin/bash
    interactive_cmd: test -s MAIN_CONTAINER_ID && LC_ALL=POSIX docker exec -it $(cat MAIN_CONTAINER_ID) chroot $${rootfs_container_dir} /bin/bash
    workdir: /
    proxy_cache: 172.17.0.1

bootstrap:
  - prepare_docker
  - start_docker

setup:
  - "@base"

export:
  - tag_docker_image:
    - commit_container:
      - exec_local: docker commit $(< MAIN_CONTAINER_ID) $${docker_image}:$${kameleon_short_uuid}
